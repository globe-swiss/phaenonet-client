name: Deploy

on:
  workflow_dispatch:
    inputs:
      project:
        description: Project
        required: true
        default: phaenonet-test
        type: choice
        options:
          - phaenonet
          - phaenonet-test
      tag:
        description: Tag
        required: true
        type: choice
        default: none
        options:
          - none
          - patch
          - minor
          - major
  push:
    branches: [master, test-master]

env:
  PROJECT: ${{ github.event.inputs.project || 'phaenonet-test' }}
  NODE_VERSION: '<loaded from .env>'
  PNPM_VERSION: '<loaded from .env>'
  REVIEWDOG_VERSION: '<loaded from .env>'

# No default permissions - each job explicitly defines what it needs
permissions: {}

jobs:
  next-versions:
    permissions:
      contents: read
    runs-on: ubuntu-22.04
    outputs:
      tag: ${{ steps.set-tag.outputs.tag }}
      version: ${{ steps.set-version.outputs.version }}
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: 'Get previous tag'
        id: previoustag
        uses: 'WyriHaximus/github-action-get-previous-tag@v1.4.0'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
      - name: 'Get next versions'
        id: semvers
        uses: 'WyriHaximus/github-action-next-semvers@v1.2.1'
        with:
          version: ${{ steps.previoustag.outputs.tag }}
      - name: Set tag
        id: set-tag
        env:
          INPUT_TAG: ${{ github.event.inputs.tag }}
          V_MAJOR: ${{ steps.semvers.outputs.v_major }}
          V_MINOR: ${{ steps.semvers.outputs.v_minor }}
          V_PATCH: ${{ steps.semvers.outputs.v_patch }}
        run: |
          if [ "$INPUT_TAG" = "major" ]; then
            echo "tag=$V_MAJOR" >> $GITHUB_OUTPUT
          elif [ "$INPUT_TAG" = "minor" ]; then
            echo "tag=$V_MINOR" >> $GITHUB_OUTPUT
          elif [ "$INPUT_TAG" = "patch" ]; then
            echo "tag=$V_PATCH" >> $GITHUB_OUTPUT
          else
            echo "tag=" >> $GITHUB_OUTPUT
          fi
      - name: Set version
        id: set-version
        env:
          INPUT_TAG: ${{ github.event.inputs.tag }}
          TAG: ${{ steps.set-tag.outputs.tag }}
          SHA: ${{ github.sha }}
        run: |
          if [ "$INPUT_TAG" != "none" ]; then
            echo "version=phaenonet-client@$TAG" >> $GITHUB_OUTPUT
          else
            echo "version=phaenonet-client@$SHA" >> $GITHUB_OUTPUT
          fi
  build:
    permissions:
      contents: read
    name: Build
    runs-on: ubuntu-22.04
    needs: next-versions
    if: always()
    env:
      VERSION: ${{ needs.next-versions.outputs.version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6.0.2
        with:
          persist-credentials: false
      - name: Set environment variables
        run: cat .env >> $GITHUB_ENV
      - uses: pnpm/action-setup@v4.2.0
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - name: Install Dependencies
        run: pnpm install
      - name: 'set release version: ${{ env.VERSION }}'
        run: sed -ri "s|'#VERSION#'|'${VERSION}'|" src/environments/environment*.ts
      - name: Build
        run: pnpm exec ng build ${{ env.PROJECT == 'phaenonet' && '--c=production' || '' }}
      - name: Upload Artifact
        uses: ./.github/actions/upload-zip-artifact
        with:
          name: ${{ env.PROJECT }}
          path: dist
          node_version: ${{ env.NODE_VERSION }}
  sentry:
    permissions:
      contents: read
    name: Sentry
    needs:
      - build
      - next-versions
    runs-on: ubuntu-22.04
    env:
      VERSION: ${{ needs.next-versions.outputs.version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6.0.2
        with:
          persist-credentials: false
      - name: Set environment variables
        run: cat .env >> $GITHUB_ENV
      - name: Download Artifact
        uses: ./.github/actions/download-zip-artifact
        with:
          name: ${{ env.PROJECT }}
          node_version: ${{ env.NODE_VERSION }}
      - uses: pnpm/action-setup@v4.2.0
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - run: pnpm install
      - name: Release ${{ env.VERSION }}
        run: |
          echo "Create new release ${VERSION}"
          pnpm exec sentry-cli releases new ${VERSION}
          pnpm exec sentry-cli releases set-commits ${VERSION} --auto
          pnpm exec sentry-cli releases files ${VERSION} upload-sourcemaps ./dist/phaenonet/browser -x=js -x=map -x=css -i=**/src_assets_i18n* --validate --verbose --rewrite --strip-common-prefix
          pnpm exec sentry-cli releases finalize ${VERSION}
          echo "Finalized release ${VERSION}"
          echo "Adding deployment for ${ENVIRONMENT} environment"
          pnpm exec sentry-cli releases deploys ${VERSION} new --env ${ENVIRONMENT}
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: phaenonet
          SENTRY_PROJECT: phaenonet-client
          ENVIRONMENT: ${{ env.PROJECT == 'phaenonet' && 'production' || 'test' }}
  deploy:
    permissions:
      contents: read
      id-token: write # Required for GCP Workload Identity Federation (google-github-actions/auth)
    concurrency: deploy
    name: Deploy
    needs: build
    runs-on: ubuntu-22.04
    environment: ${{ github.event.inputs.project || 'phaenonet-test' }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6.0.2
        with:
          persist-credentials: false
      - name: Set environment variables
        run: cat .env >> $GITHUB_ENV
      - name: Checkout rules
        uses: actions/checkout@v6.0.2
        with:
          repository: globe-swiss/phaenonet-client-security
          path: security
          ssh-key: ${{ secrets.SECURITY_REPO_DEPLOY_KEY }}
          persist-credentials: false
      - name: Download Artifact
        uses: ./.github/actions/download-zip-artifact
        with:
          name: ${{ env.PROJECT }}
          node_version: ${{ env.NODE_VERSION }}
      - name: Remove source maps (prod)
        run: find ./dist -type f -name "*.map" -print -exec rm {} + | grep -q . # fail if no source maps found
        if: ${{ env.PROJECT == 'phaenonet' }}
      - uses: pnpm/action-setup@v4.2.0
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      - run: pnpm install
      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3.0.0
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          create_credentials_file: true
      - name: Deploy to Firebase
        run: pnpm exec firebase deploy --project ${PROJECT}
  tag:
    name: Tag
    needs:
      - deploy
      - next-versions
    runs-on: ubuntu-22.04
    permissions:
      contents: write # Required to create git tags (tvdias/github-tagger)
    if: ${{ github.event.inputs.tag != null && github.event.inputs.tag != 'none' }}
    steps:
      - name: Tag version ${{ needs.next-versions.outputs.tag }}
        uses: tvdias/github-tagger@v0.0.2
        with:
          repo-token: '${{ secrets.GITHUB_TOKEN }}'
          tag: ${{ needs.next-versions.outputs.tag }}
