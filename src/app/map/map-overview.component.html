<div class="map-overview">
  <google-map width="100%" height="100%" [center]="center" [zoom]="zoom" [options]="options">
    <map-marker
      #marker="mapMarker"
      *ngFor="let individualWithMarkerOpts of individualsWithMarkerOpts$ | async"
      [position]="individualWithMarkerOpts.individual.geopos"
      [options]="individualWithMarkerOpts.markerOptions"
      (mapClick)="
        openInfoWindow(marker, individualWithMarkerOpts.individual.geopos, individualWithMarkerOpts.individual)
      "
    >
    </map-marker>
    <map-info-window>
      <ng-container *ngIf="(infoWindowType$ | async) === 'individual'">
        <ng-container *ngIf="globeInfoWindowData$ | async as d">
          <div [routerLink]="d.url" class="map-overview__info-window">
            <div class="map-overview__info-window-image-container">
              <img class="map-overview__info-window-image" *ngIf="d.imgUrl$ | async" [src]="d.imgUrl$ | async" />
            </div>
            <div class="map-overview__info-window-text">
              <div class="map-overview__info-window-label">
                {{ d.species.de | translate }}
              </div>
              <div class="map-overview__info-window-value">{{ d.individual.name }}</div>
              <div class="map-overview__info-window-label" *ngIf="d.phenophase">
                {{ 'Letzte Beobachtung' | translate }},
                {{ formatShortDate(d.individual.last_observation_date.toDate()) }}
              </div>
              <div *ngIf="d.phenophase" class="map-overview__info-window-value">
                {{ d.phenophase?.de | translate }}
              </div>
            </div>
          </div>
        </ng-container>
      </ng-container>

      <ng-container *ngIf="(infoWindowType$ | async) === 'station'">
        <ng-container *ngIf="stationInfoWindowData$ | async as d">
          <div class="map-overview__info-window" [routerLink]="d.url">
            <img src="assets/img/pic_placeholder.svg" style="max-height: 100px" />
            <div class="map-overview__info-window-text">
              <div class="map-overview__info-window-caption">
                {{ d.individual.source | translate }}
              </div>
              <div>{{ d.individual.name }}</div>
            </div>
          </div>
        </ng-container>
      </ng-container>
    </map-info-window>
  </google-map>
  <div class="map-overview__map-actions">
    <button mat-fab class="map-overview__extended-fab-button" color="primary" [routerLink]="'/individuals/new/edit'">
      <mat-icon>add</mat-icon>
      <span>{{ 'Objekt hinzufügen' | translate }}</span>
    </button>
  </div>
  <div class="map-overview__map-filter">
    <div>
      <form [formGroup]="filter">
        <div id="form-year">
          <mat-form-field>
            <mat-label>{{ 'Phänojahr' | translate }}</mat-label>
            <mat-select formControlName="year">
              <mat-option *ngFor="let year of years$ | async" [value]="year">{{ year }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div id="form-datasource">
          <mat-form-field>
            <mat-label>{{ 'Datenquelle' | translate }}</mat-label>
            <mat-select formControlName="datasource">
              <mat-option *ngFor="let datasource of datasources" [value]="datasource">{{
                datasource | translate
              }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div id="form-species">
          <mat-form-field>
            <mat-label>{{ 'Art' | translate }}</mat-label>
            <mat-select formControlName="species">
              <mat-option *ngFor="let specie of species$ | async" [value]="specie.id">{{
                specie.de | translate
              }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </form>
    </div>
  </div>
</div>
